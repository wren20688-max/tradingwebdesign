<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Methods ‚Äî PreoTrade FX</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- TOP NAVIGATION BAR -->
  <header class="top-nav">
    <div class="nav-left">
      <button id="menuToggle" class="menu-toggle">‚ò∞</button>
      <div class="logo" style="width: 32px; height: 32px; margin: 0 8px;">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="lg3" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#0055ff;stop-opacity:1" /><stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" /></linearGradient></defs><circle cx="100" cy="100" r="95" fill="none" stroke="url(#lg3)" stroke-width="2" opacity="0.3"/><path d="M 100 30 L 150 60 L 150 130 L 100 160 L 50 130 L 50 60 Z" fill="url(#lg3)" opacity="0.1"/><g><rect x="70" y="95" width="8" height="35" fill="#00d084" opacity="0.9"/><line x1="74" y1="85" x2="74" y2="135" stroke="#00d084" stroke-width="2"/><rect x="85" y="75" width="8" height="55" fill="#00d084" opacity="0.95"/><line x1="89" y1="65" x2="89" y2="135" stroke="#00d084" stroke-width="2"/><rect x="100" y="55" width="8" height="75" fill="#0055ff" opacity="1"/><line x1="104" y1="45" x2="104" y2="135" stroke="#0055ff" stroke-width="2"/><rect x="115" y="80" width="8" height="50" fill="#00d4ff" opacity="0.9"/><line x1="119" y1="70" x2="119" y2="135" stroke="#00d4ff" stroke-width="2"/></g></svg>
      </div>
      <h1>PreoTrade FX</h1>
    </div>
    <div class="nav-center">
      <span class="balance-display">Balance: <strong id="balance">$10,000.00</strong></span>
    </div>
    <div class="nav-right">
      <button id="toggleMode" class="nav-btn">Theme</button>
      <a href="index.html" class="nav-btn logout">Logout</a>
    </div>
  </header>

  <!-- SIDE MENU -->
  <nav id="sideMenu" class="side-menu">
    <button class="menu-close">&times;</button>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">Dashboard</a>
      <a href="auto-trading.html" class="menu-item">Auto Trading</a>
      <a href="finances.html" class="menu-item">üí∞ Finances</a>
      <a href="transactions.html" class="menu-item">üìã Transactions</a>
      <a href="payment-methods.html" class="menu-item active">üí≥ Payment Methods</a>
      <a href="profile.html" class="menu-item">üë§ Profile</a>
    </div>
  </nav>

  <main class="main-container page-container">
    <!-- PAGE HEADER -->
    <div class="page-header">
      <h2>üí≥ Payment Methods</h2>
      <p>Manage your deposit and withdrawal methods</p>
    </div>

    <!-- PAYMENT OPTIONS -->
    <div class="payment-options">
      <!-- M-Pesa with PayHero Integration -->
      <section class="content-card payment-card">
        <h3>üì± M-Pesa (Pay via PayHero)</h3>
        <p>Enter M-Pesa number ‚Üí Pay via PayHero in KSH</p>
        <button class="action-btn" onclick="selectPaymentMethod('mpesa')">Select M-Pesa</button>
      </section>

      <!-- Bank Transfer -->
      <section class="content-card payment-card">
        <h3>üè¶ Bank Transfer</h3>
        <p>Wire transfer to our business account</p>
        <button class="action-btn" onclick="selectPaymentMethod('bank')">Select Bank Transfer</button>
      </section>

      <!-- Crypto Options -->
      <section class="content-card payment-card">
        <h3>üîó Cryptocurrency</h3>
        <p>Pay with your preferred cryptocurrency</p>
        <div class="crypto-grid">
          <button class="action-btn small" onclick="selectPaymentMethod('usdt')">üí≤ USDT</button>
          <button class="action-btn small" onclick="selectPaymentMethod('bitcoin')">‚Çø Bitcoin</button>
          <button class="action-btn small" onclick="selectPaymentMethod('ethereum')">Œû Ethereum</button>
          <button class="action-btn small" onclick="selectPaymentMethod('tron')">‚ü° Tron</button>
        </div>
      </section>
    </div>

    <!-- PAYMENT DETAILS -->
    <div id="paymentDetails" class="content-card" style="display:none; margin-top:20px;">
      <button class="action-btn outline" onclick="backToPaymentList()">‚Üê Back</button>
      <h3 id="paymentDetailsTitle">Payment Method</h3>
      
      <!-- STK Push Modal for M-Pesa -->
      <div id="stkPushModal" style="display:none; margin-top:20px; padding:20px; background:rgba(0,212,255,0.1); border:1px solid rgba(0,212,255,0.3); border-radius:12px;">
        <div style="margin-bottom:20px;">
          <h4 style="margin: 0 0 12px 0; color: var(--text-primary);">üì± STK Push - Enter Your Details</h4>
          <p style="margin: 0; font-size:13px; color: var(--text-secondary);">A prompt will pop up on your phone to enter your M-Pesa PIN</p>
        </div>
        
        <div style="display: grid; gap: 12px;">
          <div>
            <label style="display:block; font-size:12px; color:var(--text-tertiary); margin-bottom:6px; font-weight:600;">Phone Number</label>
            <input type="tel" id="mpesaPhone" placeholder="+254712345678 or 0712345678" style="width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary); font-size:14px;">
            <small style="color:var(--text-tertiary); display:block; margin-top:4px;">Format: +254712345678 or 0712345678</small>
          </div>
          
          <div>
            <label style="display:block; font-size:12px; color:var(--text-tertiary); margin-bottom:6px; font-weight:600;">Amount (USD)</label>
            <input type="number" id="mpesaAmount" placeholder="100" min="10" step="0.01" style="width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-secondary); color:var(--text-primary); font-size:14px;">
            <small style="color:var(--text-tertiary); display:block; margin-top:4px;">Minimum: $10</small>
          </div>
          
          <button class="action-btn" onclick="initiateStkPush()" style="margin-top:8px;">
            <span style="display:inline-block; margin-right:8px;">üì≤</span> Send STK Push
          </button>
          
          <!-- STK Response -->
          <div id="stkResponse" style="display:none; margin-top:16px; padding:14px; background:rgba(0,208,132,0.1); border:1px solid rgba(0,208,132,0.3); border-radius:8px; text-align:center;">
            <div style="font-size:32px; margin-bottom:8px;">üì§</div>
            <p style="margin:0; font-weight:600; color:var(--success);">STK Push Sent!</p>
            <p style="margin:8px 0 0 0; font-size:13px; color:var(--text-secondary);">Check your phone and enter your M-Pesa PIN</p>
            <div id="stkPhoneDisplay" style="margin-top:12px; font-size:12px; color:var(--text-tertiary); background:var(--bg-tertiary); padding:10px; border-radius:6px; font-family:monospace;"></div>
            <button class="action-btn outline" onclick="resetStkPush()" style="margin-top:12px; font-size:13px;">Clear</button>
          </div>
        </div>
      </div>
      
      <!-- Regular Payment Info -->
      <div id="paymentInfo" style="margin-top:15px; line-height:1.8;"></div>
      <div style="text-align:center; margin-top:20px;">
        <p style="font-size:12px; color:#888;">Copy and send payment to complete your transaction</p>
      </div>
    </div>
  </main>

  <script src="storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!storage.isLoggedIn()) {
        window.location.href = 'index.html';
        return;
      }

      loadBalance();
      setupMenuToggle();
    });

    function loadBalance() {
      const balance = storage.getBalance('demo');
      document.getElementById('balance').textContent = '$' + balance.toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    function selectPaymentMethod(method) {
      const details = {
        mpesa: { title: 'M-Pesa (Pay via PayHero)', info: 'Enter your M-Pesa number and pay via PayHero in KSH', showStk: true },
        bank: { title: 'Bank Transfer', info: 'Account: 1234567890\\nBank: Global Finance Bank\\nSwift: GFBKXX\\nMinimum: $50', showStk: false },
        usdt: { title: 'USDT (TRC20)', info: 'Address: TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t\\nNetwork: TRC20\\nMinimum: $10', showStk: false },
        bitcoin: { title: 'Bitcoin', info: 'Address: 1A1z7agoat7SBLkjvotQwNLac5cBacK8h2\\nNetwork: Bitcoin\\nMinimum: $50', showStk: false },
        ethereum: { title: 'Ethereum', info: 'Address: 0x742d35Cc6634C0532925a3b844Bc9e7595f42e7\\nNetwork: ETH\\nMinimum: $10', showStk: false },
        tron: { title: 'TRON', info: 'Address: TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t\\nNetwork: Tron\\nMinimum: $10', showStk: false }
      };

      const detail = details[method];
      if (detail) {
        document.getElementById('paymentDetailsTitle').textContent = detail.title;
        
        // Show STK push modal for M-Pesa
        if (detail.showStk) {
          document.getElementById('stkPushModal').style.display = 'block';
          document.getElementById('paymentInfo').innerHTML = '';
        } 
        // Show regular payment info
        else {
          document.getElementById('stkPushModal').style.display = 'none';
          document.getElementById('paymentInfo').innerHTML = '<pre style="white-space:pre-wrap; word-wrap:break-word;">' + detail.info + '</pre>';
        }
        
        document.getElementById('paymentDetails').style.display = 'block';
      }
    }

    function initiateStkPush() {
      const phone = document.getElementById('mpesaPhone').value.trim();
      const amount = parseFloat(document.getElementById('mpesaAmount').value);
      
      // Validate phone number - accept +254XXXXXXXXX or 07XXXXXXXXX or 01XXXXXXXXX
      if (!phone.match(/^(\+254|0)[17]\d{8}$/)) {
        alert('Please enter a valid M-Pesa phone number (e.g., +254712345678 or 0712345678)');
        return;
      }
      
      if (!amount || amount < 10) {
        alert('Amount must be at least $10');
        return;
      }
      
      console.log('STK Push initiated for:', phone, 'Amount:', amount);
      
      // Request notification permission first
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            sendBrowserNotification('STK Push Sent', 'Check your phone for M-Pesa payment prompt');
          }
          proceedWithStkPush(phone, amount);
        });
      } else if ('Notification' in window && Notification.permission === 'granted') {
        sendBrowserNotification('STK Push Sent', 'Check your phone for M-Pesa payment prompt');
        proceedWithStkPush(phone, amount);
      } else {
        proceedWithStkPush(phone, amount);
      }
    }

    function proceedWithStkPush(phone, amount) {
      // Show success message
      document.getElementById('stkResponse').style.display = 'block';
      document.getElementById('stkPhoneDisplay').textContent = 'Phone: ' + phone + '\nAmount: $' + amount.toFixed(2) + '\nStatus: ‚è≥ Redirecting to PayHero...';
      
      // Proceed to PayHero after 2 seconds
      setTimeout(() => {
        showPayheroPayment(phone, amount);
      }, 2000);
    }

    function showPayheroPayment(phone, amount) {
      // Convert USD to KSH (1 USD = 130 KSH approx)
      const kshAmount = Math.round(amount * 130);
      
      const paymentRef = prompt('üí≥ PayHero Payment\n\nM-Pesa Number: ' + phone + '\nUSD Amount: $' + amount.toFixed(2) + '\nKSH Amount: KSH ' + kshAmount + '\n\nProceed to PayHero to complete payment.\n\n(Enter confirmation or click OK):', '');
      
      if (paymentRef !== null) {
        // Simulate PayHero payment completion
        setTimeout(() => {
          const refNo = 'PH-' + Date.now();
          sendBrowserNotification('‚úÖ Payment Completed', 'Amount: KSH ' + kshAmount + ' | Ref: ' + refNo);
          alert('‚úÖ PayHero Payment Completed!\n\nM-Pesa: ' + phone + '\nAmount: KSH ' + kshAmount + '\nReference: ' + refNo + '\n\nYour account has been credited.');
          resetStkPush();
          backToPaymentList();
          
          // Update balance
          const newBalance = storage.getBalance('demo') + amount;
          storage.setBalance(newBalance, 'demo');
          loadBalance();
        }, 1500);
      }
    }

    function resetStkPush() {
      document.getElementById('mpesaPhone').value = '';
      document.getElementById('mpesaAmount').value = '';
      document.getElementById('stkResponse').style.display = 'none';
    }

    function sendBrowserNotification(title, message) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
          body: message,
          icon: '/assets/logo.png',
          badge: '/assets/logo-badge.png',
          tag: 'preotrade-payment',
          requireInteraction: false
        });
      }
    }

    function backToPaymentList() {
      document.getElementById('paymentDetails').style.display = 'none';
    }

    function setupMenuToggle() {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.querySelector('.menu-close');
      const logout = document.querySelector('.logout');
      const toggleMode = document.getElementById('toggleMode');

      if (menuToggle) menuToggle.addEventListener('click', () => sideMenu?.classList.add('active'));
      if (menuClose) menuClose.addEventListener('click', () => sideMenu?.classList.remove('active'));
      if (logout) logout.addEventListener('click', (e) => {
        e.preventDefault();
        storage.removeUser();
        window.location.href = 'index.html';
      });
      if (toggleMode) toggleMode.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
      });

      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
      }
    }
  </script>
</body>
</html>
