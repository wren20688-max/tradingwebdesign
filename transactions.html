<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions ‚Äî PreoCrypto</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- TOP NAVIGATION BAR -->
  <header class="top-nav">
    <div class="nav-left">
      <button id="menuToggle" class="menu-toggle">‚ò∞</button>
      <div class="logo" style="width: 32px; height: 32px; margin: 0 8px;">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#0055ff;stop-opacity:1" /><stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" /></linearGradient></defs><circle cx="100" cy="100" r="95" fill="none" stroke="url(#lg2)" stroke-width="2" opacity="0.3"/><path d="M 100 30 L 150 60 L 150 130 L 100 160 L 50 130 L 50 60 Z" fill="url(#lg2)" opacity="0.1"/><g><rect x="70" y="95" width="8" height="35" fill="#00d084" opacity="0.9"/><line x1="74" y1="85" x2="74" y2="135" stroke="#00d084" stroke-width="2"/><rect x="85" y="75" width="8" height="55" fill="#00d084" opacity="0.95"/><line x1="89" y1="65" x2="89" y2="135" stroke="#00d084" stroke-width="2"/><rect x="100" y="55" width="8" height="75" fill="#0055ff" opacity="1"/><line x1="104" y1="45" x2="104" y2="135" stroke="#0055ff" stroke-width="2"/><rect x="115" y="80" width="8" height="50" fill="#00d4ff" opacity="0.9"/><line x1="119" y1="70" x2="119" y2="135" stroke="#00d4ff" stroke-width="2"/></g></svg>
      </div>
      <h1>PreoCrypto</h1>
    </div>
    <div class="nav-center">
      <span class="balance-display">Balance: <strong id="balance">$10,000.00</strong></span>
    </div>
    <div class="nav-right">
      <button id="toggleMode" class="nav-btn">Theme</button>
      <a href="index.html" class="nav-btn logout">Logout</a>
    </div>
  </header>

  <!-- SIDE MENU -->
  <nav id="sideMenu" class="side-menu">
    <button class="menu-close">&times;</button>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">Dashboard</a>
      <a href="auto-trading.html" class="menu-item">Auto Trading</a>
      <a href="finances.html" class="menu-item">Finances</a>
      <a href="transactions.html" class="menu-item active">Transactions</a>
      <a href="payment-methods.html" class="menu-item">Payment Methods</a>
      <a href="profile.html" class="menu-item">Profile</a>
    </div>
  </nav>

  <main class="main-container page-container">
    <!-- PAGE HEADER -->
    <div class="page-header">
      <h2>üìã Transaction History</h2>
      <p>View all your account transactions</p>
    </div>

    <!-- FILTERS -->
    <section class="content-card">
      <h3>Filters</h3>
      <div class="filters-group">
        <select id="transactionFilter" class="form-control">
          <option value="all">All Transactions</option>
          <option value="deposit">Deposits</option>
          <option value="withdrawal">Withdrawals</option>
          <option value="trade">Trades</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
        </select>
        <input type="date" id="dateFrom" class="form-control" placeholder="From Date">
        <input type="date" id="dateTo" class="form-control" placeholder="To Date">
        <button class="action-btn" onclick="applyTransactionFilters()">üîç Apply Filters</button>
      </div>
    </section>

    <!-- TRANSACTIONS LIST -->
    <section class="content-card">
      <h3>All Transactions</h3>
      <div id="allTransactionsList" class="transactions-table">
        <div class="empty-state">Loading transactions...</div>
      </div>
    </section>
  </main>

  <script src="storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (!storage.isLoggedIn()) {
        window.location.href = 'index.html';
        return;
      }

      loadBalance();
      loadTransactions();
      setupMenuToggle();
    });

    function loadBalance() {
      const balance = storage.getBalance('demo');
      document.getElementById('balance').textContent = '$' + balance.toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    function loadTransactions() {
      const el = document.getElementById('allTransactionsList');
      const user = JSON.parse(localStorage.getItem('preo_user') || '{}');
      const isMarketer = user.isMarketer || false;
      const userEmail = user.email || user.username;
      
      console.log('üîç Loading transactions for:', userEmail, 'isMarketer:', isMarketer);
      
      let transactions = [];
      
      // Get trades from storage - only show closed trades
      const tradesData = localStorage.getItem('preo_trades');
      if (tradesData) {
        try {
          const trades = JSON.parse(tradesData);
          transactions = transactions.concat(trades
            .filter(trade => trade.status === 'closed')
            .map(trade => ({
              date: new Date(trade.timestamp).toISOString().split('T')[0],
              type: `Trade Closed - ${trade.pnl >= 0 ? 'Profit' : 'Loss'} of $${Math.abs(trade.pnl || 0).toFixed(2)}`,
              method: trade.pair,
              amount: (trade.pnl >= 0 ? '+' : '') + '$' + Math.abs(trade.pnl || 0).toFixed(2),
              status: 'Completed'
            })));
        } catch (e) { console.error('Error loading trades:', e); }
      }
      
      // Get deposits from storage - filter by current user
      const depositsData = localStorage.getItem('deposits');
      if (depositsData) {
        try {
          const deposits = JSON.parse(depositsData);
          console.log('üìä All deposits:', deposits);
          const userDeposits = deposits.filter(d => d.user === userEmail || d.user === user.username);
          console.log('üí∞ Filtered deposits for user:', userDeposits);
          transactions = transactions.concat(userDeposits.map(d => ({
            date: new Date(d.timestamp).toISOString().split('T')[0],
            type: 'Deposit',
            method: d.method,
            amount: '+$' + (d.amount || 0).toFixed(2),
            status: d.status === 'completed' ? 'Completed' : 'Pending'
          })));
        } catch (e) { console.error('Error loading deposits:', e); }
      }
      
      // Get withdrawals from storage - filter by current user
      const withdrawalsData = localStorage.getItem('withdrawals');
      if (withdrawalsData) {
        try {
          const withdrawals = JSON.parse(withdrawalsData);
          transactions = transactions.concat(withdrawals
            .filter(w => w.user === userEmail || w.user === user.username)
            .map(w => ({
              date: new Date(w.timestamp).toISOString().split('T')[0],
              type: 'Withdrawal',
              method: w.method,
              amount: '-$' + (w.amount || 0).toFixed(2),
              status: isMarketer ? 'Completed' : 'Pending'
            })));
        } catch (e) { console.error('Error loading withdrawals:', e); }
      }
      
      // Sort by date descending (newest first)
      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      console.log('üìã Total transactions:', transactions.length, transactions);
      
      // If no transactions, show empty message with demo data option
      if (transactions.length === 0) {
        el.innerHTML = `
          <div style="padding: 30px; text-align: center; color: var(--text-secondary);">
            <p>No transactions yet. Start trading to see your activity here.</p>
            <p style="font-size: 12px; margin-top: 10px; color: #888;">Debug: Email=${userEmail}, isMarketer=${isMarketer}</p>
            <button onclick="loadDemoTransactions()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              Load Demo Data
            </button>
          </div>
        `;
        return;
      }

      el.innerHTML = transactions.map(t => `
        <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${t.type}</strong>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">${t.date} ‚Ä¢ ${t.method}</div>
          </div>
          <div style="text-align: right;">
            <strong style="color: ${t.amount.startsWith('+') ? 'var(--success)' : 'var(--danger)'}">${t.amount}</strong>
            <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px;">${t.status}</div>
          </div>
        </div>
      `).join('');
    }

    function applyTransactionFilters() {
      alert('Filter applied!');
    }

    function setupMenuToggle() {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.querySelector('.menu-close');
      const logout = document.querySelector('.logout');
      const toggleMode = document.getElementById('toggleMode');

      if (menuToggle) menuToggle.addEventListener('click', () => sideMenu?.classList.add('active'));
      if (menuClose) menuClose.addEventListener('click', () => sideMenu?.classList.remove('active'));
      if (logout) logout.addEventListener('click', (e) => {
        e.preventDefault();
        storage.removeUser();
        window.location.href = 'index.html';
      });
      if (toggleMode) toggleMode.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
      });

      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
      }
    }

    function loadDemoTransactions() {
      // Create sample transactions for demo/testing
      const demoTransactions = [
        { type: 'trade_win', date: '2025-12-09', amount: 125.50, method: 'EUR/USD', timestamp: Date.now() - 3600000 },
        { type: 'trade_loss', date: '2025-12-09', amount: -75.25, method: 'GBP/USD', timestamp: Date.now() - 7200000 },
        { type: 'deposit', date: '2025-12-08', amount: 500.00, method: 'M-Pesa', timestamp: Date.now() - 86400000 }
      ];
      
      localStorage.setItem('preo_transactions', JSON.stringify(demoTransactions));
      
      // Also add some demo trades
      const demoTrades = [
        { 
          id: Date.now() - 10000, 
          pair: 'EUR/USD', 
          type: 'BUY', 
          volume: 1, 
          entryPrice: 1.0945,
          stopLoss: 1,
          takeProfit: 2,
          timestamp: new Date().toISOString(),
          status: 'closed',
          pnl: 125.50,
          entryTime: Date.now() - 3600000
        },
        {
          id: Date.now() - 20000,
          pair: 'GBP/USD',
          type: 'SELL',
          volume: 0.5,
          entryPrice: 1.2638,
          stopLoss: 1,
          takeProfit: 2,
          timestamp: new Date(Date.now() - 7200000).toISOString(),
          status: 'closed',
          pnl: -75.25,
          entryTime: Date.now() - 7200000
        }
      ];
      
      localStorage.setItem('preo_trades', JSON.stringify(demoTrades));
      
      // Reload transactions
      loadTransactions();
      alert('Demo data loaded! You can now see sample transactions.');
    }
  </script>
</body>
</html>
